<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funding Monitor - CEX</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .funding-positive { color: #10B981; }
        .funding-negative { color: #EF4444; }
        .funding-neutral { color: #6B7280; }
        .table-container { max-height: 70vh; overflow-y: auto; }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <i class="fas fa-chart-line text-blue-600 text-2xl mr-3"></i>
                        <h1 class="text-2xl font-bold text-gray-900">Funding Monitor</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-sm text-gray-600" id="status">Connected</span>
                        </div>
                        <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-sync-alt"></i>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exchange-alt text-blue-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Pairs</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalPairs">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-arrow-up text-green-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Positive Funding</p>
                            <p class="text-2xl font-semibold text-gray-900" id="positiveFunding">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-arrow-down text-red-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Negative Funding</p>
                            <p class="text-2xl font-semibold text-gray-900" id="negativeFunding">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Last Update</p>
                            <p class="text-sm font-semibold text-gray-900" id="lastUpdate">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Exchange</label>
                        <select id="exchangeFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Exchanges</option>
                            <option value="binance">Binance</option>
                            <option value="bybit">Bybit</option>
                            <option value="okx">OKX</option>
                            <option value="mexc">MEXC</option>
                                            <option value="bitget">Bitget</option>
                <option value="gate">Gate.io</option>
                <option value="deribit">Deribit</option>
                <option value="xt">XT.com</option>
                <option value="kucoin">KuCoin</option>
            </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Symbol</label>
                        <input type="text" id="symbolFilter" placeholder="e.g., BTCUSDT" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Funding Rate</label>
                        <select id="fundingFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All</option>
                            <option value="positive">Positive</option>
                            <option value="negative">Negative</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                        <select id="sortBy" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="funding_rate">Funding Rate</option>
                            <option value="symbol">Symbol</option>
                            <option value="exchange">Exchange</option>
                            <option value="next_funding">Next Funding</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Alert Settings -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Funding Rate Alerts</h3>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="alertEnabled" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Enable Alerts</span>
                        </label>
                        <button id="testAlertBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
                            Test Alert
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alert Threshold (%)</label>
                        <input type="number" id="alertThreshold" value="0.1" step="0.01" min="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Alert when funding rate changes by this percentage</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alert Sound</label>
                        <select id="alertSound" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="browser">Browser Default</option>
                            <option value="custom">Custom Sound</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alert History</label>
                        <div id="alertHistory" class="text-sm text-gray-600 max-h-20 overflow-y-auto">
                            No alerts yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Funding Rates Table -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Funding Rates</h3>
                </div>
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exchange</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funding Rate</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Funding</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mark Price</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Funding</th>
                            </tr>
                        </thead>
                        <tbody id="fundingTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        let fundingData = [];
        let filteredData = [];
        let previousFundingData = new Map(); // Store previous funding rates
        let alertThreshold = 0.001; // 0.1% change threshold for alerts
        let alertEnabled = true;
        let alertHistory = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadFundingRates();
            setupEventListeners();
            setInterval(loadFundingRates, 30000); // Refresh every 30 seconds
        });

        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', loadFundingRates);
            document.getElementById('exchangeFilter').addEventListener('change', filterData);
            document.getElementById('symbolFilter').addEventListener('input', filterData);
            document.getElementById('fundingFilter').addEventListener('change', filterData);
            document.getElementById('sortBy').addEventListener('change', sortData);
            
            // Alert controls
            document.getElementById('alertEnabled').addEventListener('change', function() {
                alertEnabled = this.checked;
            });
            document.getElementById('alertThreshold').addEventListener('change', function() {
                alertThreshold = parseFloat(this.value) / 100; // Convert percentage to decimal
            });
            document.getElementById('testAlertBtn').addEventListener('click', testAlert);
        }

        async function loadFundingRates() {
            try {
                const response = await fetch('/api/funding');
                const data = await response.json();
                
                const newFundingData = data.rates || [];
                
                // Check for funding rate changes and trigger alerts
                if (alertEnabled && previousFundingData.size > 0) {
                    checkFundingRateChanges(newFundingData);
                }
                
                // Update previous data for next comparison
                previousFundingData.clear();
                newFundingData.forEach(rate => {
                    const key = `${rate.symbol}-${rate.exchange}`;
                    previousFundingData.set(key, rate.funding_rate);
                });
                
                fundingData = newFundingData;
                updateStats();
                filterData();
                updateLastUpdate();
                
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').parentElement.querySelector('.w-3').className = 'w-3 h-3 bg-green-500 rounded-full';
            } catch (error) {
                console.error('Error loading funding rates:', error);
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').parentElement.querySelector('.w-3').className = 'w-3 h-3 bg-red-500 rounded-full';
            }
        }

        function updateStats() {
            const totalPairs = fundingData.length;
            const positiveFunding = fundingData.filter(rate => rate.funding_rate > 0).length;
            const negativeFunding = fundingData.filter(rate => rate.funding_rate < 0).length;

            document.getElementById('totalPairs').textContent = totalPairs;
            document.getElementById('positiveFunding').textContent = positiveFunding;
            document.getElementById('negativeFunding').textContent = negativeFunding;
        }

        function filterData() {
            const exchangeFilter = document.getElementById('exchangeFilter').value;
            const symbolFilter = document.getElementById('symbolFilter').value.toLowerCase();
            const fundingFilter = document.getElementById('fundingFilter').value;

            filteredData = fundingData.filter(rate => {
                const exchangeMatch = !exchangeFilter || rate.exchange === exchangeFilter;
                const symbolMatch = !symbolFilter || rate.symbol.toLowerCase().includes(symbolFilter);
                const fundingMatch = !fundingFilter || 
                    (fundingFilter === 'positive' && rate.funding_rate > 0) ||
                    (fundingFilter === 'negative' && rate.funding_rate < 0) ||
                    (fundingFilter === 'neutral' && rate.funding_rate === 0);

                return exchangeMatch && symbolMatch && fundingMatch;
            });

            sortData();
        }

        function sortData() {
            const sortBy = document.getElementById('sortBy').value;
            
            filteredData.sort((a, b) => {
                switch (sortBy) {
                    case 'funding_rate':
                        return Math.abs(b.funding_rate) - Math.abs(a.funding_rate);
                    case 'symbol':
                        return a.symbol.localeCompare(b.symbol);
                    case 'exchange':
                        return a.exchange.localeCompare(b.exchange);
                    case 'next_funding':
                        return new Date(a.next_funding_time) - new Date(b.next_funding_time);
                    default:
                        return 0;
                }
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('fundingTableBody');
            tbody.innerHTML = '';

            filteredData.forEach(rate => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const fundingRateClass = rate.funding_rate > 0 ? 'funding-positive' : 
                                       rate.funding_rate < 0 ? 'funding-negative' : 'funding-neutral';
                
                const nextFundingTime = new Date(rate.next_funding_time).toLocaleString();
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <a href="/pair.html?symbol=${encodeURIComponent(rate.symbol)}&exchange=${encodeURIComponent(rate.exchange)}" 
                           class="text-blue-600 hover:text-blue-800 hover:underline">
                            ${rate.symbol}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rate.exchange.toUpperCase()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${fundingRateClass}">
                        ${(rate.funding_rate * 100).toFixed(4)}%
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${nextFundingTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rate.mark_price ? rate.mark_price.toFixed(2) : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${rate.last_funding_rate ? (rate.last_funding_rate * 100).toFixed(4) + '%' : '-'}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        function checkFundingRateChanges(newData) {
            const alerts = [];
            
            newData.forEach(rate => {
                const key = `${rate.symbol}-${rate.exchange}`;
                const previousRate = previousFundingData.get(key);
                
                if (previousRate !== undefined) {
                    const change = Math.abs(rate.funding_rate - previousRate);
                    const changePercent = change * 100;
                    
                    if (change >= alertThreshold) {
                        const direction = rate.funding_rate > previousRate ? 'increased' : 'decreased';
                        const alert = {
                            symbol: rate.symbol,
                            exchange: rate.exchange,
                            oldRate: previousRate,
                            newRate: rate.funding_rate,
                            change: changePercent,
                            direction: direction,
                            timestamp: new Date()
                        };
                        alerts.push(alert);
                    }
                }
            });
            
            if (alerts.length > 0) {
                showAlerts(alerts);
            }
        }

        function showAlerts(alerts) {
            alerts.forEach(alert => {
                // Browser notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Funding Rate Alert', {
                        body: `${alert.symbol} (${alert.exchange}) ${alert.direction} by ${alert.change.toFixed(4)}%`,
                        icon: '/favicon.ico'
                    });
                }
                
                // Browser alert (fallback)
                if (document.getElementById('alertSound').value === 'browser') {
                    alert(`ðŸš¨ Funding Rate Alert!\n\n${alert.symbol} (${alert.exchange.toUpperCase()})\n${alert.direction} by ${alert.change.toFixed(4)}%\n\nPrevious: ${(alert.oldRate * 100).toFixed(4)}%\nCurrent: ${(alert.newRate * 100).toFixed(4)}%`);
                }
                
                // Add to alert history
                addToAlertHistory(alert);
            });
        }

        function addToAlertHistory(alert) {
            const timestamp = alert.timestamp.toLocaleTimeString();
            const message = `${timestamp}: ${alert.symbol} (${alert.exchange}) ${alert.direction} by ${alert.change.toFixed(4)}%`;
            
            alertHistory.unshift(message);
            if (alertHistory.length > 10) {
                alertHistory.pop();
            }
            
            updateAlertHistory();
        }

        function updateAlertHistory() {
            const historyDiv = document.getElementById('alertHistory');
            if (alertHistory.length === 0) {
                historyDiv.innerHTML = 'No alerts yet';
            } else {
                historyDiv.innerHTML = alertHistory.map(msg => `<div class="text-xs mb-1">${msg}</div>`).join('');
            }
        }

        function testAlert() {
            const testAlert = {
                symbol: 'TEST',
                exchange: 'test',
                oldRate: 0.001,
                newRate: 0.002,
                change: 0.1,
                direction: 'increased',
                timestamp: new Date()
            };
            showAlerts([testAlert]);
        }

        // Request notification permission on page load
        document.addEventListener('DOMContentLoaded', function() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
    </script>
</body>
</html> 